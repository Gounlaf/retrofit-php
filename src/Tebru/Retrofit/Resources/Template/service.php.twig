
namespace {{ 'Tebru\\Retrofit\\Service\\NS' ~ className }}
{
    use GuzzleHttp\ClientInterface;
    use JMS\Serializer\SerializerInterface;
    use Tebru\Retrofit\RequestInterceptor;
{% for use in uses %}
    {{ use }}
{% endfor %}

    class {{ className }} implements \{{ interfaceName }}
    {
        private $baseUrl;
        private $client;
        private $serializer;
        private $requestInterceptor;

        public function __construct($baseUrl, ClientInterface $client, SerializerInterface $serializer, RequestInterceptor $requestInterceptor = null)
        {
            $this->baseUrl = $baseUrl;
            $this->client = $client;
            $this->serializer = $serializer;
            $this->requestInterceptor = $requestInterceptor;
        }
{% for method in methods %}

        {{ method.methodDeclaration }}
        {
            $options = {{ export_php_array(method.options)|raw }};
{% if method.options.body is not empty %}
            if (is_object({{ method.options.body }})) {
                $options['body'] = $this->serializer->serialize({{ method.options.body }}, 'json');
            } else {
                $options['body'] = {{ method.options.body }};
            }

{% elseif method.parts is not empty %}
            $options['body'] = {{ export_php_array(method.parts)|raw }};
{% endif %}

            $request = $this->client->createRequest('{{ method.type|upper }}', $this->baseUrl . "{{ method.path }}", $options);

            $queries = {{ export_php_array(method.query)|raw }};
            $headers = {{ export_php_array(method.headers)|raw }};

            if (null !== $this->requestInterceptor) {
                $queries = array_merge($queries, $this->requestInterceptor->getQueries());
                $headers = array_merge($headers, $this->requestInterceptor->getHeaders());
            }

            $request->setQuery($queries);
            $request->addHeaders($headers);

            $response = (string)$this->client->send($request)->getBody();

{% if 'raw' == method.return %}
            return $response;
{% elseif 'array' == method.return %}
            return json_decode($response, true);
{% else %}
            return $this->serializer->deserialize($response, '{{ method.return }}', 'json');
{% endif %}
        }
{% endfor %}
    }
}
